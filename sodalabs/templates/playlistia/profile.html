{% extends "base.html" %}
{% block javascript_includes %}
<script type="text/javascript" src="/site_media/js/swfobject/src/swfobject.js"></script>
{% endblock %}

{% block content %}
<script type="text/javascript">

function onYouTubePlayerReady(playerId) {
    ytplayer = document.getElementById('ytPlayer');
    ytplayer.addEventListener('onStateChange','Playlist.onPlayerStateChange');
    ytplayer.playVideo();
    Playlist.player = ytplayer;
}

var Playlist = {
    songs : new Array(),
    currentSong : false,
    player : false,

    open : function(songId) {
        songId = parseInt(songId);
        q = Playlist.songs[songId];

        Playlist.currentSong = songId;
        $.get('/playlist/open/',{'q':q}, function(data) {
                jsonData = JSON.parse(data);
                if(jsonData['status']=='ok') {
                    Playlist.play(jsonData['video_id'], jsonData['video_title']);
                } else { 
                    elem = Playlist.getElemById(songId);
                    elem.html('(error) ' + elem.html());       
                    Playlist.goToNext();
                }
        });
        return false;
    },

    play : function(id,title) {
        /*
        * Simple player embed
        */
        songId = Playlist.currentSong;
        $('.recent_song').attr('class','recent_song');
        elem = Playlist.getElemById(songId);
        $(elem).attr('class','recent_song now_playing');
        $('#title').html(title);
        if(Playlist.player) {
            Playlist.player.loadVideoById(id);
        } else {
            // The video to load.
            var videoID = id
            // Lets Flash from another domain call JavaScript
            var params = { allowScriptAccess: "always" };
            // The element id of the Flash embed
            var atts = { id: "ytPlayer" };
            // All of the magic handled by SWFObject (http://code.google.com/p/swfobject/)
            swfobject.embedSWF("http://www.youtube.com/v/" + videoID + "&enablejsapi=1&playerapiid=player1",
                               "videoDiv", "480", "295", "8", null, null, params, atts);

        }


    },

    getElemById : function(id) {
        return $('#'+id);
    },

    onPlayerStateChange : function(state) {
        if (state==0) {
            Playlist.goToNext();
        }
    },
    
    goToNext : function() {
        songId = Playlist.currentSong+1;
        Playlist.open(songId);
    }

}
</script>
<div id="youtube_container">
<h1 id="title">Hello...</h1>
<div  id="videoDiv">Loading...</div>
</div>

<div id="lastfm_container">
<h1>{{username}} on lastfm</h1>
<div style="clear:both;"></div>
<div id="lastfm_friends_container" class="lastfm_list_container">
    <h3>friends</h3>
    <ul id="friends_list" class="vertical_list">
    {% for friend in lastfm_friends %}
        <li class="vertical_item"><a href="/playlist/user/{{friend.name}}">{{friend.name}}</a></li>
    {% empty %}
        <li class="vertical_item">No friends found...</li>
    {% endfor %}
    </ul>
</div>
<div id="lastfm_neighbours_container" class="lastfm_list_container">
    <h3>neighbours</h3>
    <ul id="neighbours_list" class="vertical_list">
    {% for neighbour in lastfm_neighbours %}
        <li class="vertical_item"><a href="/playlist/user/{{neighbour.name}}">{{neighbour.name}}</a></li>
    {% empty %}
        <li class="vertical_item">No neighbours found...</li>
    {% endfor %}
    </ul>
</div>
<div id="lastfm_recents_container" class="lastfm_list_container">
<h3>recent scrobbles</h3>
<ul id="recent_list" class="vertical_list" >
{% for recent in lastfm_recents %}
<script type="text/javascript">
    $(document).ready(function() {
        qString = '{{recent.name|escape}} {{recent.artist|escape}}';
        length = Playlist.songs.push(qString);
        id = length-1;
        $('#'+id).bind('click',function() {
            Playlist.open($(this).attr('id'));
        });
    });
</script>
<li class="vertical_item"><a class="recent_song" id="{{forloop.counter0}}" href="#{{recent.artist}}-{{recent.name}}" >{{recent.artist}} - {{recent.name}}</a></li>
{% empty %}
<li class="vertical_item">No songs found...</li>
{% endfor %}
</ul>
</div>
<script type="text/javascript">
    $(document).ready(function() {
        Playlist.open(0);
    });
</script>
</div>
{% endblock %}
